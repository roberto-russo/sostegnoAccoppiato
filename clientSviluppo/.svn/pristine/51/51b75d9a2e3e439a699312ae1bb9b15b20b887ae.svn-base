package it.csi.demetra.demetraws.zoo.calcoli;

import java.time.LocalDate;
import java.time.Period;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import it.csi.demetra.demetraws.zoo.calcoli.entity.CapiControllati9901;
import it.csi.demetra.demetraws.zoo.calcoli.entity.Capo9901;
import it.csi.demetra.demetraws.zoo.calcoli.entity.Ref;
import it.csi.demetra.demetraws.zoo.interfaces.RefInterface;
import it.csi.demetra.demetraws.zoo.util.DateUtilService;
import it.csi.demetra.demetraws.zoo.util.LocalDateConverter;

public class Ref9901 extends Ref implements RefInterface<CapiControllati9901>, Calcolo {
	
	private static final Logger LOGGER = LoggerFactory.getLogger(Ref9901.class);

	private CapiControllati9901 capiControllati = new CapiControllati9901();
	
	private static final int GIORNI_27 = 27;
	private static final int GIORNI_34 = 34;
	private static final int GIORNI_180 = 180;
	private static final int GIORNI_187 = 187;
	
	private boolean metodoEseguitoCorrettamente;
	
	public Ref9901(String idBdn, String codIntervento,String annoCampagna, String cuaa) {

		setIdBdn(idBdn);
		setCodIntrervento(codIntervento);
		setAnnoCampagna(annoCampagna);
		setCuaa(cuaa);
		
	}
	/**
	 * CALCOLO 9901
	 * 
	 * Il calcolo invoca il metodo calcoloTempisticaDiRegistrazione()
	 * 
	 * Il metodo ritorna un oggetto contenente :
	 * 
	 * 1- la lista dei capi controllati con flagCapoAmmesso = 'S'/'N' e la motivazione
	 * 2- un campo booleano esito che indica se il calcoloTempisticaDiRegistrazione() è andato a buon fine
	 * 3- una stringa motivazioneEsitoCalcolo che contiene le motivazioni dell'esito del calcolo
	 * 
	 * @return capiControllati
	 * @throws CalcoloException 
	 */
	@Override
	public CapiControllati9901 calcolo() throws CalcoloException {
		
		preEsecuzione();
		esecuzione();
		postEsecuzione();
		
		return capiControllati;
		
	}
	
	/**
	 * TEMPISTICA REGISTRAZIONE CAPI
	 * 
	 * tempisticaRegistrazione = tI + tR
	 * 
	 * Il calcolo dei due parametri è dato da:
	 * 
	 *	tI = [Data di identificazione del vitello] - [Data di nascita del vitello] 
	 *	tR = [Data di registrazione in BDN della nascita del capo] - [Data di identificazione del vitello]
	 * 
	 * Se l'esecuzione non presenta problemi: return true
	 * Se ci sono stati errori durante l'esecuzione: return false
	 * 
	 * @return true/false
	 * 
	 */
	
	private boolean calcoloTempisticaDiRegistrazione() {
		

		LOGGER.info("Inizio Calcolo Tempistica di Registrazione 9901: calcoloTempisticaDiRegistrazione() ");
		
		try {
			
			for (Capo9901 capo: capiControllati.getListaCapi9901()) {
				
				if(	   capo.getCapo().getDtNascitaVitello() != null 	  		&& 
					   capo.getCapo().getVitelloDtApplMarchio() != null 		&& 
					   capo.getCapo().getVitelloDtInserBdnNascita() != null	&&
					   !"".equals((capo.getCapo().getFlagDelegato())) 			&&
					   !"".equals((capo.getCapo().getFlagProrogaMarcatura()))		) 
				{
					
					Date dataIdentificazioneVitello = capo.getCapo().getVitelloDtApplMarchio();
					Date dataNascitaVitello = capo.getCapo().getDtNascitaVitello();
					Date dataRegistrazioneVitelloBDN = capo.getCapo().getVitelloDtInserBdnNascita();
					
					String flagDelegato = capo.getCapo().getFlagDelegato();
					String flagProrogaMarcatura = capo.getCapo().getFlagProrogaMarcatura();
					int tempisticaRegistrazione;
					int numGiorniFestiviCompresi = 0;

					LocalDate dataIdVit = LocalDateConverter.convertToLocalDateViaInstant(dataIdentificazioneVitello);
					LocalDate dataNascitaVit = LocalDateConverter.convertToLocalDateViaInstant(dataNascitaVitello);
					LocalDate dataRegVit = LocalDateConverter.convertToLocalDateViaInstant(dataRegistrazioneVitelloBDN);
					
					List<Date> giorniFestivi = DateUtilService.getGiorniFestivi(String.valueOf(dataNascitaVit.getYear()));
					
					Date dataRegistrazioneBDNMenoSette = LocalDateConverter.convertToDateViaInstant(dataRegVit.minusDays(7));
					
					Period periodtI = Period.between(dataIdVit, dataNascitaVit);
					Period periodtR = Period.between(dataIdVit, dataRegVit);

					capo.settI(periodtI.getDays());
					capo.settR(periodtR.getDays());
					
					tempisticaRegistrazione = capo.gettI() + capo.gettR();
					
					
					
					if ( flagDelegato.equalsIgnoreCase("N") && flagProrogaMarcatura.equalsIgnoreCase("N") ) {
						//Caso 1 :
						if( tempisticaRegistrazione <= GIORNI_27 ) {
							capo.setFlagCapoAmmesso("S");
							capo.setMotivazione("Tempistica di registrazione rispettata");
						} else {
							capo.setFlagCapoAmmesso("N");
							capo.setMotivazione("Tempistica di registrazione non rispettata. "
									  		  + "Il capo è stato registrato con un ritardo di "+ ( tempisticaRegistrazione - GIORNI_27 ) +" giorni.");
						}
						
					} else if ( flagDelegato.equalsIgnoreCase("N") && flagProrogaMarcatura.equalsIgnoreCase("S") ) {
						//Caso 2 :
						if( tempisticaRegistrazione <= GIORNI_34 ) {
							
							capo.setFlagCapoAmmesso("S");
							capo.setMotivazione("Tempistica di registrazione rispettata");
							
						} else {
							
							capo.setFlagCapoAmmesso("N");
							capo.setMotivazione("Tempistica di registrazione non rispettata. "
											  + "Il capo è stato registrato con un ritardo di "+ ( tempisticaRegistrazione - GIORNI_34 ) +" giorni.");
						
						}
						
					} else if ( flagDelegato.equalsIgnoreCase("S") && flagProrogaMarcatura.equalsIgnoreCase("N") ) {
						//Caso 3 :
						if( tempisticaRegistrazione <= GIORNI_180 ) {
							
							capo.setFlagCapoAmmesso("S");
							capo.setMotivazione("Tempistica di registrazione rispettata");

				
						} else {
							
							capo.setFlagCapoAmmesso("N");
							capo.setMotivazione("Tempistica di registrazione non rispettata. "
									  		  + "Il capo è stato registrato con un ritardo di "+ ( tempisticaRegistrazione - GIORNI_180 ) +" giorni.");
				
						}
						
					} else if ( flagDelegato.equalsIgnoreCase("S") && flagProrogaMarcatura.equalsIgnoreCase("S") ) {
						//Caso 4 :
						for (Date giorno : giorniFestivi) {
							if( giorno.after(dataRegistrazioneBDNMenoSette) && giorno.before(dataRegistrazioneVitelloBDN )) {
								numGiorniFestiviCompresi += 1;
							}
						}
						
						if( numGiorniFestiviCompresi > 0 ) {
							
							if( tempisticaRegistrazione <= (GIORNI_187 + numGiorniFestiviCompresi) ) {
								
								capo.setFlagCapoAmmesso("S");
								capo.setMotivazione("Tempistica di registrazione rispettata");

							} else {
								
								capo.setFlagCapoAmmesso("N");
								capo.setMotivazione("Tempistica di registrazione non rispettata. "
										  		  + "Il capo è stato registrato con un ritardo di "+ ( tempisticaRegistrazione - ( GIORNI_187 + numGiorniFestiviCompresi) ) +" giorni.");
					
							}
							
						} else {
							
							if( tempisticaRegistrazione <= GIORNI_187 ) {
								
								capo.setFlagCapoAmmesso("S");
								capo.setMotivazione("Tempistica di registrazione rispettata");

							} else {
								
								capo.setFlagCapoAmmesso("N");
								capo.setMotivazione("Tempistica di registrazione non rispettata. "
										  		  + "Il capo è stato registrato con un ritardo di "+ ( tempisticaRegistrazione - GIORNI_187 ) +" giorni.");
					
							}
						}
					}
					
				} else {
					
					System.err.println("Campi del capo non valorizzati correttamente");
					LOGGER.error("Errore nel Calcolo Tempistica di Registrazione 9901: - Campi del capo non valorizzati correttamente");
					return false;
				}
				
			}
			
			LOGGER.info("Fine Calcolo Tempistica di Registrazione 9901: calcoloTempisticaDiRegistrazione() ");
			
			
			controllaAmmissibilita(capiControllati);
			
			return true;
			
		} catch (Exception e) {
			
			System.err.println(e);
			LOGGER.error("Errore nel Calcolo Tempistica di Registrazione 9901: - ",e);
			return false;
			
		}
	}
	
	/**
	 * 
	 * VERIFICA DI AMMISSIBILITÀ 
	 * Se tutti i capi sono stati ammessi,
	 * allora la vacca è ammissibile a premio (esito=true),
	 * altrimenti la vacca non è ammissibile a premio (esito=false).
	 * 
	 * @param capiControllati
	 * 
	 */
	private void controllaAmmissibilita(CapiControllati9901 capiControllati) {
		
		LOGGER.info("Inizio Controllo Ammissibilità 9901: controllaAmmissibilita() ");
		
		try {
			for (Capo9901 capo: capiControllati.getListaCapi9901()) {
				if(capo.getFlagCapoAmmesso().equalsIgnoreCase("N")) {
					CapiControllati9901.setEsito(false);
					CapiControllati9901.setMotivazioneEsitoCalcolo("Non tutti i capi hanno superato il controllo di ammissibilità" );
					break;
				}
			}
			
			LOGGER.info("Fine Controllo Ammissibilità 9901: controllaAmmissibilita() ");
			
		} catch (Exception e) {
			
			System.err.println(e);
			LOGGER.error("Errore nel Controllo Ammissibilità 9901: - ",e);
			
		}
		
	}
	
	/**
	 * 
	 * RECUPERO DATI 
	 * Il metodo recuperaDatiCapi() serve a 
	 * recuperare i dati inerenti i capi che dovranno essere controllati.
	 * 
	 * 
	 * 
	 */
	private void recuperoDatiCapi() {
		
		LOGGER.info("Inizio Recupero Dati: recuperoDatiCapi() ");
		
		try {
			//RECUPERO CON REPOSITORY O SERVICE
			List<Capo9901> listaCapi9901 = new ArrayList<Capo9901>();

			for (Capo9901 capo: listaCapi) {
				listaCapi9901.add(new Capo9901(capo,0,0));
			}
			
			capiControllati.setListaCapi9901(listaCapi9901);
			
			
			LOGGER.info("Fine Recupero Dati: recuperoDatiCapi() ");
			
		} catch (Exception e) {
			
			System.err.println(e);
			LOGGER.error("Errore nel Controllo recuperoDatiCapi 9901: - ",e);
			
		}
		
	}
	@Override
	public void preEsecuzione() throws CalcoloException {
		recuperoDatiCapi();
		
	}
	@Override
	public void esecuzione() throws CalcoloException {
		
		LOGGER.info("Inizio Calcolo 9901: calcolo() ");
		
		metodoEseguitoCorrettamente = calcoloTempisticaDiRegistrazione();
		
		
	}
	@Override
	public void postEsecuzione() throws CalcoloException {
		// SALVATAGGIO DATI
		
		if(metodoEseguitoCorrettamente) {
			CapiControllati9901.setEsito(true);
			CapiControllati9901.setMotivazioneEsitoCalcolo("Il calcolo della tempistica di registrazione è stato eseguito correttamente");
			LOGGER.info("Fine Calcolo9901: calcolo() ");
		} else {
			CapiControllati9901.setEsito(false);
			CapiControllati9901.setMotivazioneEsitoCalcolo("Ci sono stati degli errori durante il calcolo della tempistica di registrazione");
			LOGGER.error("Errore nel Calcolo 9901");
		}
		
	}

}
