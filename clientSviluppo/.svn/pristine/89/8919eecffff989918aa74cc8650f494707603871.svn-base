package it.csi.demetra.demetraws.zoo;

import java.text.ParseException;

import javax.xml.bind.JAXBException;

import org.springframework.beans.factory.annotation.Autowired;

import it.csi.demetra.demetraws.srmanags.wsbridge2.Response;
import it.csi.demetra.demetraws.srmanags.wsbridge2.WSBridge2;
import it.csi.demetra.demetraws.srmanags.wsbridge2.WSBridgeInternalException_Exception;
import it.csi.demetra.demetraws.srmanags.wsbridge2.WSBridgeService;
import it.csi.demetra.demetraws.zoo.model.Dmt_d_clsPremio_ValidazioneResponse;
import it.csi.demetra.demetraws.zoo.model.Dmt_t_errore;
import it.csi.demetra.demetraws.zoo.model.Dmt_t_sessione;
import it.csi.demetra.demetraws.zoo.model.DsUBA_censimenti_allevamenti_ovini;
import it.csi.demetra.demetraws.zoo.repository.Dmt_t_errore_repository;
import it.csi.demetra.demetraws.zoo.services.Dmt_t_errore_services;
import it.csi.demetra.demetraws.zoo.services.SaveOnDbService;
import it.csi.demetra.demetraws.zoo.transformer.TransformerData;
import org.springframework.stereotype.Component;

@Component
public class BdnWsManagerImpl {

	@Autowired
	SaveOnDbService save;
	
	@Autowired
	Dmt_t_errore_services erroreService;

	WSBridge2 wsBridge2;
	
	Response response;

	public BdnWsManagerImpl() {
		this.wsBridge2 = new WSBridgeService().getWSBridge2Port();
	}

	public void getElencoCapiPremio(String codiceIntervento, String cuaa, Integer anno_campagna, Dmt_t_sessione sessione) {
		
		try {
			response = wsBridge2.getElencoCapiPremioNew(codiceIntervento, cuaa, anno_campagna);
			
			System.out.println("RESPONSE INFO: " + response.getInfo());
			System.out.println("RESPONSE COD RET: " + response.getCodRet());
			System.out.println("RESPONSE CODICE ERRORE: " + response.getCodiceErrore());
			System.out.println("RESPONSE DESCRIZIONE ERRORE: " + response.getDescrizioneErrore());
			System.out.println("RESPONSE ESITO: " + response.getEsito());
			
			System.out.println("CUAA: " + response.getVCapiVacche().get(0).getCuaa());
			
			System.out.println("ID SESSIONE IN BdnWsManagerImpl: " + sessione.getIdSessione());

			TransformerData transform = new TransformerData();
			Dmt_d_clsPremio_ValidazioneResponse bean = transform.TransformDmt_d_clsPremio_ValidazioneResponse(response, sessione);

			// lavora i dati raccolti

			save.saveOnDb(bean);

		} catch (WSBridgeInternalException_Exception | NullPointerException | IndexOutOfBoundsException | IllegalStateException e1) {
			/* SALVARE A DB RESPONSE.GETCODICEERRORE E RESPONSE.GETDESCRIZIONEERRORE */
			System.out.println("LA CHIAMATA AL METODO DELLA BDN E' NULL");
			Dmt_t_errore errore = new Dmt_t_errore();
			
			String input = new String("-1, dati non disponibili");
			errore.setNomeMetodo("getElencoCapiPremioNew");
			errore.setInput(input);
			System.out.println("ID SESSIONE ERRORE: " + sessione.getIdSessione());
			errore.setSessione(sessione);
			erroreService.saveError(errore);
			
			System.out.println("FINE SALVATAGGIO A DB DELL'ERRORE");
			
		} catch (JAXBException | ParseException e) {
			System.out.println(e.getCause() + ", " + e.getMessage());
		}

	}

	public void getElencoCapiPremio2(Long idAlleBdn, String codiceIntervento, String cuaa, String cuua2,
			Integer annoCampagna,Dmt_t_sessione sessione) throws JAXBException, WSBridgeInternalException_Exception, ParseException {

		// prendi i dati con chiamata http dalla bdn
		Response response = wsBridge2.getElencoCapiPremio2New(idAlleBdn, codiceIntervento, cuaa, cuua2, annoCampagna);

		TransformerData transform = new TransformerData();
		Dmt_d_clsPremio_ValidazioneResponse bean = transform.TransformDmt_d_clsPremio_ValidazioneResponse(response, sessione);

		// bean
		// lavora i dati raccolti
		// salva su db
		save.saveOnDb(bean);
	}

	public void Consistenza_UBA_Censim_Ovini_2012(String p_cuaa, String data_inizio_periodo, String Data_fine_periodo,
			String p_tipo_responsabilita, Dmt_t_sessione sessione) throws WSBridgeInternalException_Exception, JAXBException {

		// prendi i dati con chiamata http dalla bdn
		Response response = wsBridge2.getConsistenzaUbaCensimOvini2012(p_cuaa, data_inizio_periodo, Data_fine_periodo,
				p_tipo_responsabilita); // oggetto risposta ritornato dalla bdn
		TransformerData transform = new TransformerData();

		DsUBA_censimenti_allevamenti_ovini bean = transform.TransformDsUBA_censimenti_allevamenti_ovini(response, sessione);

		// bean
		// lavora i dati raccolti

		// salva su db
		save.saveOnDb(bean);
	}
}
